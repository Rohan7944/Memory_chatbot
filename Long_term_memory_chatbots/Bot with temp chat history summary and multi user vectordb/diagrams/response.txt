 ┌────────────────────────────────────────────┐
 │  prepare_llm_response_with_resources()     │
 └────────────────────────────────────────────┘
                     │
                     ▼
     ┌────────────────────────────────────┐
     │ Initialize base system prompt      │
     │ (prepare_basic_chat_system_prompt) │
     └────────────────────────────────────┘
                     │
                     ▼
     ┌────────────────────────────────────┐
     │ For each resource in:              │
     │  [chat_history,                    │
     │   chat_summary,                    │
     │   user_vectordb_results,           │
     │   general_vectordb_results]        │
     └────────────────────────────────────┘
                     │
                     ▼
           ┌───────────────────────────────┐
           │ inject_data_resource()        │
           └───────────────────────────────┘
                     │
       ┌─────────────┼──────────────────────┐
       ▼              ▼                     ▼
   Resource empty?  Enough tokens?     Context breach?
       │              │                    │
       │              │                    │
   ┌───┴───┐    ┌────┴────┐          ┌─────┴──────┐
   │ Skip  │    │ Inject  │          │ Summarize  │
   │       │    │ directly│          │ and retry  │
   └───┬───┘    └────┬────┘          └─────┬──────┘
       │             │                     │
       └─────────────┴─────────────────────┘
                     │
                     ▼
     ┌────────────────────────────────────┐
     │ If MAX_ITERATIONS reached →        │
     │ proceed with current prompt        │
     └────────────────────────────────────┘
                     │
                     ▼
     ┌────────────────────────────────────┐
     │ Generate final LLM response        │
     │(get_llm_response(prompt, question))│
     └────────────────────────────────────┘
                     │
                     ▼
     ┌────────────────────────────────────┐
     │ Return final_response              │
     └────────────────────────────────────┘